# 物理预览功能使用指南

## 版本：v2.1.0

## 概述
物理预览功能允许你实时查看设计的物理场景在 Box2D 物理引擎中的运行效果。

## 功能特性

### 1. 启动预览
- **点击预览按钮**：工具栏上的 "▶ 预览" 按钮
- **快捷键**：按 `Space` 键

### 2. 预览控制
预览模式下，顶部会显示浮动控制面板：

- **⏸ 暂停**：暂停物理模拟（按钮或 `Space` 键）
- **▶ 播放**：恢复物理模拟
- **🔄 重置**：重置场景到初始状态
- **❌ 退出**：退出预览模式（按钮或 `ESC` 键）

### 3. 预览模式特点
- 编辑功能被禁用
- 属性面板自动隐藏
- 物体按照真实物理规律运动
- 支持动态、静态和运动学刚体
- 支持旋转关节的角度限制
- 重力加速度：9.8 m/s²（向下）

## 工作原理

### Box2D 集成
- 使用 `box2d.js` 库（从 `/box2d-js/lib/box2d.js` 加载）
- 创建 Box2D 世界（`b2World`）
- 将设计的物体转换为 Box2D 刚体（`b2Body`）
- 将设计的关节转换为 Box2D 关节（`b2Joint`）

### 物理模拟
- 时间步长：1/60 秒（60 FPS）
- 速度迭代次数：8
- 位置迭代次数：3
- 每帧调用 `b2World.Step()` 更新物理状态

### 渲染更新
- 从 Box2D 物体读取位置和角度
- 同步到设计对象
- 使用现有渲染函数绘制

## 使用步骤

### 基本流程
1. **设计场景**
   - 创建物体（矩形、圆形、多边形）
   - 设置物体类型（动态/静态/运动学）
   - 添加关节连接物体
   - 调整物理属性（密度、摩擦、弹性等）

2. **启动预览**
   - 点击 "▶ 预览" 按钮或按 `Space` 键
   - 系统会检查 Box2D 是否加载
   - 系统会检查是否有物体
   - 创建 Box2D 世界并开始模拟

3. **观察效果**
   - 物体会根据重力和相互作用运动
   - 可以暂停观察某个时刻的状态
   - 可以重置回到初始状态

4. **退出预览**
   - 点击 "❌ 退出" 按钮或按 `ESC` 键
   - 返回编辑模式
   - 属性面板恢复显示

## 物理属性说明

### 刚体类型
- **动态（Dynamic）**：受重力和力的影响，可以自由运动
- **静态（Static）**：不会移动，用于地面、墙壁等固定物体
- **运动学（Kinematic）**：可以设置速度移动，但不受力的影响

### 物理参数
- **密度（Density）**：影响质量（质量 = 密度 × 面积）
- **摩擦（Friction）**：影响接触面的滑动阻力（0-1）
- **弹性（Restitution）**：碰撞反弹系数（0-1）
- **线性阻尼（Linear Damping）**：减缓平移速度
- **角阻尼（Angular Damping）**：减缓旋转速度
- **锁定旋转（Fixed Rotation）**：物体不会旋转

### 关节参数
- **锚点（Anchor）**：关节连接点的位置
- **角度限制（Angle Limit）**：限制旋转范围
- **下限角度（Lower Angle）**：最小旋转角度（弧度）
- **上限角度（Upper Angle）**：最大旋转角度（弧度）

## 注意事项

### 前提条件
1. **Box2D 库必须存在**
   - 路径：`/box2d-js/lib/box2d.js`
   - 如果未找到，会弹出警告

2. **至少有一个物体**
   - 空场景无法预览
   - 会弹出提示

### 已知限制
1. **重置功能**
   - 目前简单地重建 Box2D 世界
   - 如果需要精确重置，建议退出预览后重新进入

2. **多边形顶点顺序**
   - Box2D 要求多边形顶点按逆时针顺序
   - 如果多边形表现异常，检查顶点顺序

3. **关节锚点**
   - 局部坐标转世界坐标可能有精度问题
   - 如果关节位置不准确，尝试调整锚点

## 故障排除

### 问题：点击预览后弹出 "Box2D 物理引擎未加载"
**解决方案**：
- 检查 `/box2d-js/lib/box2d.js` 文件是否存在
- 检查 `index.html` 中是否正确引入 Box2D 脚本
- 打开浏览器控制台查看加载错误

### 问题：物体在预览中不动
**可能原因**：
- 物体类型是 "静态"：改为 "动态"
- 密度为 0：设置合适的密度（如 1.0）
- 物体被关节完全约束：检查关节设置

### 问题：物体穿透其他物体
**可能原因**：
- 速度过快：增加阻尼或减小初始速度
- 多边形顶点顺序错误：重新创建多边形
- Box2D 精度问题：尝试减小物体数量

### 问题：预览卡顿
**可能原因**：
- 物体数量过多：建议少于 50 个物体
- 多边形顶点过多：简化多边形形状
- 浏览器性能不足：尝试关闭其他标签页

## 开发信息

### 实现文件
- `src/main.ts`：主要实现代码
- `index.html`：UI 控件
- `styles.css`：预览控制面板样式

### 关键方法
```typescript
togglePreview()       // 切换预览模式
startPreview()        // 启动预览
exitPreview()         // 退出预览
pausePreview()        // 暂停预览
resumePreview()       // 恢复预览
resetPreview()        // 重置预览

initBox2DWorld()      // 初始化 Box2D 世界
createBox2DBody()     // 创建 Box2D 刚体
createBox2DJoint()    // 创建 Box2D 关节
startPreviewAnimation()  // 启动动画循环
syncBox2DToObjects()  // 同步物理状态到设计对象
```

### 状态变量
```typescript
isPreviewMode: boolean              // 是否处于预览模式
box2dWorld: any                     // Box2D 世界对象
box2dBodies: Map<string, any>       // 物体ID → Box2D刚体
box2dJoints: Map<string, any>       // 关节ID → Box2D关节
previewAnimationId: number | null   // 动画帧ID
previewPaused: boolean              // 是否暂停
```

## 未来改进

### 可能的增强功能
1. **保存初始状态**
   - 完善重置功能，精确恢复初始位置和角度

2. **物理参数调试**
   - 预览时显示速度、力等调试信息
   - 允许实时调整重力、时间步长等参数

3. **更多关节类型**
   - 支持距离关节（Distance Joint）
   - 支持棱柱关节（Prismatic Joint）
   - 支持滑轮关节（Pulley Joint）

4. **性能优化**
   - 空间分区优化
   - 睡眠物体优化
   - 连续碰撞检测（CCD）

5. **导出功能**
   - 导出预览视频
   - 导出物理轨迹数据

## 反馈与支持

如有问题或建议，请联系开发者或提交 Issue。

---

**版本历史**：
- v2.1.0 (2024-01-XX)：初始物理预览功能发布
- v2.0.0 (2024-01-XX)：形状编辑功能
