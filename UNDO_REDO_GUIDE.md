# 撤销/重做功能指南

## 概述

本项目现已实现完整的撤销/重做（Undo/Redo）功能，使用经典的命令模式（Command Pattern）实现。用户可以撤销或重做最近的操作，最多支持 50 步历史记录。

## 功能特性

### 🎯 支持的操作类型

撤销/重做系统支持以下所有操作：

1. **创建对象**
   - 创建矩形刚体
   - 创建圆形刚体
   - 创建多边形刚体
   - 创建距离关节
   - 创建旋转关节

2. **删除对象**
   - 使用 Delete 键删除选中对象
   - 使用删除工具点击删除
   - 属性面板中的删除按钮

3. **移动对象**
   - 拖动刚体改变位置
   - 记录移动前后的位置变化

4. **修改属性**
   - 修改刚体类型（Static/Dynamic/Kinematic）
   - 修改物理属性（密度、摩擦力、弹性）
   - 修改阻尼参数
   - 修改重力缩放
   - 切换固定旋转状态
   - 修改关节参数

### 🖱️ 使用方法

#### 工具栏按钮
- **撤销按钮**：点击工具栏右上角的"撤销"按钮（带左箭头图标）
- **重做按钮**：点击"重做"按钮（带右箭头图标）
- 按钮会根据历史记录状态自动启用/禁用

#### 键盘快捷键
- **Ctrl + Z**：撤销上一步操作
- **Ctrl + Y**：重做被撤销的操作

### 📋 历史记录管理

- **容量限制**：最多保存 50 步操作历史
- **自动清理**：超过限制时自动删除最早的记录
- **清空规则**：执行新操作后，所有重做历史会被清空

## 实现细节

### 架构设计

#### 命令模式
使用命令模式将操作封装为对象，便于统一管理和执行/撤销操作。

```typescript
interface Command {
  execute(): void;  // 执行操作
  undo(): void;     // 撤销操作
  redo(): void;     // 重做操作
}
```

#### 命令类型

1. **AddObjectCommand**：添加对象
   - execute: 将对象添加到数组
   - undo: 从数组中移除对象
   - redo: 重新添加对象

2. **DeleteObjectCommand**：删除对象
   - execute: 从数组中移除对象
   - undo: 恢复对象到原位置
   - redo: 再次删除对象

3. **MoveObjectCommand**：移动对象
   - execute: 应用新位置
   - undo: 恢复到旧位置
   - redo: 重新应用新位置

4. **ModifyPropertyCommand**：修改属性
   - execute: 设置新属性值
   - undo: 恢复旧属性值
   - redo: 重新设置新值

5. **BatchCommand**：批量操作
   - 将多个命令组合为一个
   - 统一执行/撤销/重做

### 关键实现

#### CommandHistory 类
管理命令历史栈，提供执行、撤销、重做功能。

```typescript
class CommandHistory {
  private history: Command[] = [];     // 历史记录栈
  private currentIndex: number = -1;   // 当前位置指针
  private maxHistorySize = 50;         // 最大容量
  
  execute(command: Command): void;     // 执行新命令
  undo(): void;                        // 撤销
  redo(): void;                        // 重做
  canUndo(): boolean;                  // 是否可撤销
  canRedo(): boolean;                  // 是否可重做
}
```

#### 智能优化

1. **移动优化**：只有真正移动了位置才记录命令
   ```typescript
   if (oldX !== newX || oldY !== newY) {
     // 记录移动命令
   }
   ```

2. **属性优化**：值没变化时不记录命令
   ```typescript
   if (oldValue !== newValue) {
     // 记录属性修改命令
   }
   ```

3. **批量操作**：可将多个操作合并为一个命令，一次撤销/重做

## 使用示例

### 示例 1：创建和删除
```
1. 选择矩形工具，创建一个矩形 → 历史记录+1
2. 按 Delete 删除矩形 → 历史记录+1
3. 按 Ctrl+Z 撤销 → 矩形恢复
4. 按 Ctrl+Z 再次撤销 → 矩形被移除（撤销创建）
5. 按 Ctrl+Y 重做 → 矩形重新出现
```

### 示例 2：移动对象
```
1. 创建一个圆形
2. 拖动圆形到新位置 → 历史记录+1
3. 按 Ctrl+Z → 圆形回到原位置
4. 按 Ctrl+Y → 圆形回到新位置
```

### 示例 3：修改属性
```
1. 选中一个对象
2. 在属性面板中修改密度从 1.0 到 2.0 → 历史记录+1
3. 修改摩擦力从 0.3 到 0.5 → 历史记录+1
4. 按 Ctrl+Z → 摩擦力恢复到 0.3
5. 按 Ctrl+Z → 密度恢复到 1.0
```

### 示例 4：复杂操作流程
```
1. 创建矩形 A
2. 创建圆形 B
3. 移动矩形 A
4. 修改圆形 B 的属性
5. 创建关节连接 A 和 B
6. 连续按 Ctrl+Z 5次 → 撤销所有操作
7. 连续按 Ctrl+Y 3次 → 重做前3个操作
```

## 注意事项

### ⚠️ 限制

1. **历史容量**：最多 50 步，超出后自动删除最早记录
2. **新操作清空重做**：执行新操作后无法重做之前被撤销的操作
3. **不可撤销操作**：
   - 文件加载（Load）
   - 导出操作（Export）
   - 新建地图（New）

### 💡 最佳实践

1. **频繁保存**：虽然有撤销功能，但仍建议定期保存工作
2. **操作预览**：大改动前可以先做小测试，不满意就撤销
3. **批量操作**：复杂的调整可以一步步完成，方便精确撤销
4. **快捷键使用**：熟练使用 Ctrl+Z/Y 可以大幅提高效率

## 技术细节

### 内存管理
- 命令对象只保存必要的引用和数据
- 移动和属性修改命令只记录变化的值
- 批量命令可以减少内存占用

### 性能优化
- 命令执行时避免不必要的渲染
- 使用回调函数延迟更新 UI
- 按钮状态只在必要时更新

### 可扩展性
- 遵循开闭原则，易于添加新命令类型
- 命令接口简单统一
- 历史管理与具体命令解耦

## 未来改进

可能的功能增强：
1. **历史记录面板**：显示所有操作历史，可跳转到任意步骤
2. **操作描述**：为每个命令添加描述文本
3. **分支管理**：支持撤销后在分支点创建新的操作路径
4. **持久化历史**：保存历史记录到文件
5. **自定义容量**：允许用户设置历史记录最大数量

## 总结

撤销/重做功能极大地提升了用户体验，让用户可以大胆尝试各种操作而不必担心犯错。通过命令模式的实现，系统保持了良好的可维护性和可扩展性。

---

**文档版本**: 1.0  
**最后更新**: 2024-01  
**相关文件**: `src/core/commands.ts`, `src/main.ts`
